# Endless メソッド記事用コンテキスト

このメモは記事 `articles/a4d711bc1d3193.md` の補助資料です。本文から溢れた詳細なコードや前提をまとめています。

## CallLater / Delayed 実装全体

```ruby
module CallLater
  NULL = Class.new do
    def call = nil
    def call_later = nil
  end.new

  module Initializer
    def initialize(record) = @record = record
    attr_reader :record
    delegate :id, to: :record
  end

  def self.define(model, queue_as: :default)
    Module.new do
      extend ActiveSupport::Concern

      included do |x|
        include Delayed.define(self, :call, queue_as:), GlobalID::Identification, Initializer

        class_attribute :model, default: model
        x.define_singleton_method(:find) { |id| new(model.find(id)) }
      end
    end
  end
end
```

```ruby
module Delayed
  class << self
    def define_singleton(namespace, name = :call, queue_as: :default)
      job = build_job_static_class(queue_as:, namespace:, name:)
      namespace.const_set("delayed_#{name}_job".classify.to_sym, job)
      Module.new do
        extend ActiveSupport::Concern
        included do |target|
          target.define_singleton_method("#{name}_later") { job.perform_later(self) }
        end
      end
    end

    def define(namespace, name = :call, queue_as: :default, wait: nil, attempts: nil)
      job = build_job_class(wait:, attempts:, queue_as:, name:)
      namespace.const_set("delayed_#{name}_job".classify.to_sym, job)
      build_later_module(job, name)
    end

    def build_later_module(job, name)
      Module.new do
        define_method("#{name}_later") do |**options|
          if options[:wait]
            job.set(wait: options[:wait]).perform_later(self)
          else
            job.perform_later(self)
          end
        end
      end
    end

    def build_job_static_class(queue_as:, namespace:, name:)
      Class.new(ApplicationJob) do
        queue_as queue_as
        define_method(:perform) { namespace.try(name) }
      end
    end

    def build_job_class(wait:, attempts:, queue_as:, name:)
      Class.new(ApplicationJob) do
        retry_on(StandardError, wait:, attempts:) if wait && attempts
        queue_as queue_as
        define_method(:perform) { |record| record.try(name) }
      end
    end
  end
end
```

## weak_parameters の設定例

```ruby
class ApplicationController < ActionController::Base
  rescue_from WeakParameters::ValidationError do
    head :bad_request
  end
end
```

## Inertia でのフロント側受け取りメモ

- `flash[:verification]` に `{ user:, user_created: }` を渡すことで、Inertia 側では `page.props.flash.verification` として読み取れる。
- 新規作成時のみモーダル表示などを行いたい場合は `verification[:user_created]` を見る。

---
この記事の更新時にこのファイルも適宜整合性を取ること。
